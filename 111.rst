.. _tutorial_quickstart_report_timing:

Quick Start on Power Analysis
-----------------------------

Get Power Report
~~~~~~~~~~~~~~~~~~~~

.. note:: To keep a clean project structure, we strongly recommend users to create a new directory for a new project.

A project directory in the purpose of power analysis consists of the following subdirectories:

.. code-block::

  alkaidS_power_timebased_report
  ├── config
  │   └── ptpx_task.yaml
  ├── Makefile
  ├── netlist -> ../alkaid_v0p5_power_leakage/netlist
  ├── report.tar.gz
  ├── sdc -> ../alkaidS_power_timebased/sdc
  └── waveform -> ../alkaidS_power_timebased/waveform
  └── _snps_ptpx_<task_name>

  
where 

- the ``config`` directory contains the task configuration file. See details in the :ref:`file_format_task_file`
- the ``Makefile`` is the top-level makefile to run PTPX tasks. Refer to examples under ``tests/tasks``
- the ``netlist`` directory contains the HDL netlists that model the FPGA fabric
- the ``report.tar.gz`` directory contains the required .rpt files.
- the ``sdc`` directory contains the bitstream file for the HDL design to be analyzed
- the ``waveform`` directory is storage path for waveform files.
- the ``_snps_ptpx_<task_name>`` directory is automatically generated by PTPX runs, to host intermediate/temporary files. Please avoid to put important data inside.
.. note:: We strongly recommend to use zipped copy for bitstream files and activity files

Once the project is initialized, fill the task configuration file accordingly.

.. note:: A shortcut to create a new project is to copy an example project, e.g., ``tests/tasks/alkaidS_power_timebased_report``

Create Task Configuration
~~~~~~~~~~~~~~~~~~~~~~~~~

Fill the required data in the ``config/ptpx_task.yaml``. Refer to :ref:`file_format_task_file` for detailed explanation.

.. note:: Only the power-related information is required

Take the example of the following task configuration file, 

- For general settings such as netlists, please double check with your manager.
- For report power tasks, please select your waveform file and bitstream file properly.

.. literalinclude:: example_report_power_task.yaml
  :language: yaml

Detail Description about ``config/ptpx_task.yaml``
- **report_power**

- **Name:** and2_dynamic

- **Design:**

  - `fpga_top`

- **Method:** average

- **Variables:**

  - **ptpx_reg_clk_derate:** 0
  - **ptpx_cg_clk_derate:** 0

- **Appvars:**

  - **power_default_toggle_rate:** 0
  - **power_default_static_probability:** 0
  - **power_x_transition_derate_factor:** 0
  - **power_match_state_for_logic_x:** 0

- **SDC:**

  - `sdc/set_config_mode.tcl`

- **Reports:**

  - **Name:** power_by_cell
    - **Path:** `reports/and2_dynamic/and2_dynamic.rpt`
    - **Command:**
      - `report_power -nosplit -cell_power -area -verbose`

  - **Name:** power_by_hierarchy
    - **Path:** `reports/and2_dynamic/and2_dynamic_by_hierarchy.rpt`
    - **Command:**
      - `report_power -hierachy -levels 2 -nosplit -verbose`
    - **Remove Time Stamp:** true

  - **Name:** average_activity
    - **Path:** `reports/[current_design]/report_switching_activity.average.rpt`
    - **Command:**
      - `report_switching_activity -average_activity`
    - **Remove Time Stamp:** true

- **Power Summary**

  - **Name:** hierarchy_power
  
  - **Histogram:**
  
    - **File:** `../reports/power/histogram/power_histo.png`
      - This can be applied to hierarchical power reports.
    
    - **Data Type:** "leak power"
      - Specify the type of power values to be selected.
    
    - **Hierarchy Level:** 2
      - Can be set to "all" or an integer. Specify the level of data to be extracted from power reports containing hierarchical data.
      - Note that hierarchy contains a tab space at the beginning of a line. Refer to Fig. 4 for a detailed example.
      - In level 2, only lines matching the pattern `tile_<int>__<int>_` are considered. By default, it should be "all", resulting in all lines being extracted.
  
  - **Distribution:**
    
    - **File:** `../reports/power/histogram/power_dist.png`
      - This can be applied to hierarchical power reports.
  
    - **Data Type:** "leak power"
      - Specify the type of power values to be selected.
  
    - **Hierarchy Level:** 2
      - Same as the hierarchy_level for the histogram.
  
  - **CSV:**
  
    - **Name:** `../reports/power/csv/fpga_top_leakage.csv`
  
    - **Data Type:** "leak power"
      - Specify the type of power values to be selected.
  
    - **Hierarchy Level:** 2
      - Same as the hierarchy_level for the histogram.
  
  - **Power Tasks:**
  
    - Define the name of power tasks in the report section. This will determine where the input file is sourced from. Currently, only one report is supported. An error will be triggered if more than one report is specified.
  
    - `adder16_dynamic.fpga_top.power_by_hierarchy`
      - The format is `<task_name>.<design_name>.<report_name>`.


Run a PTPX task
~~~~~~~~~~~~~~~

We strongly recommend users to use Makefile when running a PTPX task, to avoid complicated setup processes.
Please refer to the ``Makefile`` examples, e.g., ``tests/tasks/alkaidS_power_timebased_report``.

.. literalinclude:: example_report_power_makefile

Once the setup is done, call your make target to run a PTPX task, for example:

.. code-block::

  make parse_report_only
Then you will get power report in ``tests/tasks/alkaidS_power_timebased_report/reports/``,this path will contain CSV files, histograms, and distribution plots. For detailed charts, please check the path.

